<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
<meta name="apple-mobile-web-app-capable" content="yes" />
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
<title>Camera PWA</title>
<style>
  html,body { height:100%; margin:0; background:#000; overflow:hidden; -webkit-user-select:none; user-select:none;}
  /* container covers the screen and receives touches */
  .container {
    position:fixed; inset:0; background:#000; overflow:hidden; touch-action:none;
    display:block;
  }
  /* video will be explicitly sized by JS so it always covers the viewport */
  video#camera {
    position:absolute;
    left:50%;
    top:50%;
    transform-origin:center center;
    background:#000;
    will-change: width,height,transform;
    /* allow touches to pass to container by default */
    pointer-events:none;
  }
  /* invisible helper (no UI) */
  .sr-only { position:absolute; width:1px; height:1px; padding:0; margin:-1px; overflow:hidden; clip:rect(0,0,0,0); border:0; }
</style>
</head>
<body>
  <div class="container" id="container">
    <video id="camera" autoplay playsinline muted></video>
    <div class="sr-only">Camera view â€” tap once to start.</div>
  </div>

<script>
(function(){
  const video = document.getElementById('camera');
  const container = document.getElementById('container');

  let currentFacing = 'environment';
  let stream = null;

  // detect standalone iOS/webapp mode
  const isStandalone = (('standalone' in navigator && navigator.standalone) || window.matchMedia('(display-mode: standalone)').matches);

  // debounce helper
  function debounce(fn, wait=120) {
    let t;
    return (...args) => { clearTimeout(t); t = setTimeout(()=>fn(...args), wait); };
  }

  async function startCamera(facing = currentFacing) {
    try {
      // stop previous stream
      if (stream) {
        stream.getTracks().forEach(t => t.stop());
        stream = null;
      }

      const s = await navigator.mediaDevices.getUserMedia({
        video: { facingMode: facing, width: { ideal: 1920 }, height: { ideal: 1080 } },
        audio: false
      });
      stream = s;
      video.srcObject = s;

      // wait for metadata so we can size correctly
      if (video.readyState >= 1) {
        // metadata already available
        fitVideoToScreen();
      } else {
        video.addEventListener('loadedmetadata', fitVideoToScreen, { once: true });
      }

      // start playing
      await video.play().catch(()=>{ /* ignore autoplay rejections */ });
    } catch (err) {
      console.error('startCamera error:', err);
    }
  }

  // compute and apply sizing & transform so video fills viewport and stays centered
  function fitVideoToScreen() {
    // fallback: if no metadata, fill screen
    const vw = window.innerWidth;
    const vh = window.innerHeight;

    const vidW = video.videoWidth || 1280;
    const vidH = video.videoHeight || 720;

    // decide if the intrinsic orientation is landscape
    const videoIsLandscape = vidW >= vidH;
    const screenIsLandscape = vw >= vh;

    // determine whether we need to rotate to match orientations
    // Only apply rotation correction when in standalone mode (iOS Safari usually handles rotation in browser)
    const shouldRotate = isStandalone && (videoIsLandscape !== screenIsLandscape);

    // angle in degrees (0 or 90)
    const angle = shouldRotate ? 90 : 0;

    // when rotated by 90deg the effective display aspect ratio is swapped
    const displayVideoAspect = (angle === 90 || angle === -90) ? (vidH / vidW) : (vidW / vidH);
    const screenAspect = vw / vh;

    // compute final width/height so the video covers the screen
    let finalW, finalH;
    if (screenAspect > displayVideoAspect) {
      // screen is wider than video's display aspect -> match height
      finalH = vh;
      finalW = Math.round(vh * displayVideoAspect);
    } else {
      // match width
      finalW = vw;
      finalH = Math.round(vw / displayVideoAspect);
    }

    // apply size and transform (center + optional rotation + optional mirror)
    video.style.width = finalW + 'px';
    video.style.height = finalH + 'px';

    // build transform
    const translate = 'translate(-50%, -50%)';
    const rotate = angle ? ` rotate(${angle}deg)` : '';
    const mirror = (currentFacing === 'user') ? ' scaleX(-1)
